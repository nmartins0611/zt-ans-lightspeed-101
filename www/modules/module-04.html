<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Terraform &amp; Red Hat Ansible Automation Platform (AAP 2.5)</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/course-template/modules/module-04.html">
    <link rel="prev" href="module-03.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://demo.redhat.com" target="_blank" style="margin-left: 5%;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1508.5 178.739" style="width: 278px;"><g fill="#fff"><path d="M316.6 63.2v-56H342a21.279 21.279 0 0 1 7.8 1.3 18.111 18.111 0 0 1 5.9 3.5 15.577 15.577 0 0 1 5 11.8 15.051 15.051 0 0 1-3.1 9.5 16.836 16.836 0 0 1-8.4 5.8l12.5 24.1h-9.3l-11.6-23H325v23Zm24.7-48.6H325v18.7h16.3q5.25 0 8.1-2.7a8.7 8.7 0 0 0 2.8-6.6 8.7 8.7 0 0 0-2.8-6.6c-1.8-1.9-4.5-2.8-8.1-2.8ZM364.1 42.8a20.674 20.674 0 0 1 1.6-8.2 20.288 20.288 0 0 1 4.3-6.7 19.92 19.92 0 0 1 6.5-4.5 19.718 19.718 0 0 1 8-1.6 18.463 18.463 0 0 1 7.8 1.6 18.677 18.677 0 0 1 6.2 4.5 20.927 20.927 0 0 1 4.1 6.8 23.2 23.2 0 0 1 1.5 8.4v2.3H372a13.822 13.822 0 0 0 4.6 8.4 13.6 13.6 0 0 0 9.1 3.3 15.553 15.553 0 0 0 5.7-1 12.858 12.858 0 0 0 4.6-2.6l5.1 5a25.983 25.983 0 0 1-7.4 4.1 24.69 24.69 0 0 1-8.4 1.3 21.306 21.306 0 0 1-8.4-1.6 22.763 22.763 0 0 1-6.8-4.4 20.788 20.788 0 0 1-4.5-6.7 23.2 23.2 0 0 1-1.5-8.4Zm20.2-14.2a11.527 11.527 0 0 0-8 3 13.046 13.046 0 0 0-4.2 7.8h24.2a13.091 13.091 0 0 0-4.2-7.8 11.106 11.106 0 0 0-7.8-3ZM443.1 63.2v-3.8a19.448 19.448 0 0 1-5.8 3.3 18.924 18.924 0 0 1-6.7 1.2 19.824 19.824 0 0 1-14.6-6.1 22.268 22.268 0 0 1-4.4-6.7 21.812 21.812 0 0 1 0-16.4A20.534 20.534 0 0 1 416 28a19.335 19.335 0 0 1 6.6-4.5 20.334 20.334 0 0 1 8.2-1.6 20.7 20.7 0 0 1 6.6 1 19.415 19.415 0 0 1 5.7 3V7.2l8-1.8v57.8Zm-25.2-20.4a13.718 13.718 0 0 0 4 10.1 13.45 13.45 0 0 0 9.8 4.1 14.956 14.956 0 0 0 6.4-1.3 15.954 15.954 0 0 0 4.9-3.6V33.6a14.988 14.988 0 0 0-4.9-3.5 15.271 15.271 0 0 0-6.4-1.3 13.423 13.423 0 0 0-9.9 4 13.806 13.806 0 0 0-3.9 10ZM478.1 63.2v-56h8.4v24h29.8v-24h8.4v56h-8.4V38.8h-29.8v24.4ZM547.2 64a16.483 16.483 0 0 1-10.8-3.5 11.037 11.037 0 0 1-4.2-8.9 10.375 10.375 0 0 1 4.7-9.2 20.76 20.76 0 0 1 11.8-3.2 27.841 27.841 0 0 1 5.8.6 27.374 27.374 0 0 1 5.3 1.6v-4.3a8.143 8.143 0 0 0-2.6-6.5 11.452 11.452 0 0 0-7.4-2.2 20.788 20.788 0 0 0-6 .9 34.616 34.616 0 0 0-6.6 2.6l-3-6a54.169 54.169 0 0 1 8.4-3.1 33.18 33.18 0 0 1 8.3-1.1c5.2 0 9.3 1.3 12.2 3.8s4.4 6.1 4.4 10.8v27h-7.8v-3.5a19.441 19.441 0 0 1-5.8 3.2 23.54 23.54 0 0 1-6.7 1Zm-7.3-12.6a5.646 5.646 0 0 0 2.6 4.8 11.193 11.193 0 0 0 6.6 1.8 16.256 16.256 0 0 0 5.9-1 14.449 14.449 0 0 0 4.9-2.9V47a19.778 19.778 0 0 0-4.8-1.8 24.933 24.933 0 0 0-5.7-.6 11.859 11.859 0 0 0-6.8 1.8 5.728 5.728 0 0 0-2.7 5ZM580.6 53.2v-24H572v-6.7h8.6V12.1l7.9-1.9v12.3h12v6.7h-12v22.1a5.94 5.94 0 0 0 1.4 4.4c.9.9 2.5 1.3 4.6 1.3a23.637 23.637 0 0 0 3-.2 10.857 10.857 0 0 0 2.8-.8v6.7a19.28 19.28 0 0 1-3.8.9 27.484 27.484 0 0 1-3.8.3c-3.9 0-7-.9-9-2.8-2-1.7-3.1-4.4-3.1-7.9Z"></path></g><path d="M127 90.2c12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4L149.8 37c-1.7-7.1-3.2-10.3-15.7-16.6-9.7-5-30.8-13.1-37.1-13.1-5.8 0-7.5 7.5-14.4 7.5-6.7 0-11.6-5.6-17.9-5.6-6 0-9.9 4.1-12.9 12.5 0 0-8.4 23.7-9.5 27.2a4.216 4.216 0 0 0-.3 1.9c0 9.2 36.3 39.4 85 39.4Zm32.5-11.4c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3C21.8 58.8 0 61.8 0 81c0 31.5 74.6 70.3 133.7 70.3 45.3 0 56.7-20.5 56.7-36.6-.1-12.8-11-27.3-30.9-35.9Z" fill="#e00"></path><path d="M159.5 78.8c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3l3.7-9.1a4.877 4.877 0 0 0-.3 2c0 9.2 36.3 39.4 85 39.4 12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4Z"></path><path d="M253.5 158.7a2.22 2.22 0 0 1-2.2-2.2V2.2a2.2 2.2 0 0 1 4.4 0v154.2a2.242 2.242 0 0 1-2.2 2.3Z" fill="#fff"></path><text data-name="Demo Platform" transform="translate(1186 149)" fill="#fff" font-size="82" font-family="'RedHatDisplay', 'Overpass', overpass, helvetica, arial, sans-serif" font-weight="700"><tspan x="-877.892" y="0">Demo Platform</tspan></text></svg>
      </a>
      <a class="navbar-item site-title" target="__blank" style="color: #fff !important;" href="https://redhat-scholars.github.io/course-template">Terraform &amp; Red Hat Ansible Automation Platform (AAP 2.5)</a>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item navbar-item-right-dropdown has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Links</a>
          <div class="navbar-dropdown navbar-dropdown-right">
            <a class="navbar-item navbar-item-right-content" href="https://redhat.com" target="_blank">Red Hat</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="modules" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Exercises</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="module-01.html">1. Terraform and Ansible Automation Platform 2.5</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-01.html#task1">☑️ Task 1 - Configure the Terraform Backend Credential in Ansible Automation Platform</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-01.html#task2">☑️ Task 2 - Terraform Inventory</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-01.html#task3">☑️ Task 3 - Create a Job Template to kick off a Terraform project (Terraform provider for AWS</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-01.html#task4">☑️ Task 4 - Create a Job Template to kick off a Terraform project (Terraform provider for AWS &amp; Terraform Provider for ANSIBLE Automation Platform (AAP)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="module-02.html">2. Create a Terraform-enabled Execution Environment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-02.html#task1">☑️ Task 1 - Create the configuration files for the execution environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-02.html#task2">☑️ Task 2 - Run ansible-builder</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-02.html#task3">☑️ Task 3 - Add the Terraform Execution Environment to Ansible Automation Platform</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="module-03.html">3. OPTIONAL - Terraform Basics</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-03.html#task1">☑️ Task 1 - Initialize a Terraform Project</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-03.html#task2">☑️ Task 2 - Plan and Apply the Terraform Project</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-03.html#task3">☑️ Task 3 - Make Changes to the Terraform Project</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="module-03.html#task4">☑️ Task 4 - Deprovisioning resources of a Terraform Project</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="module-04.html">4. OPTIONAL - Terraform and the Certified Collection for Terraform</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#task1">☑️ Task 1 - Install the Red Hat certified collection for Terraform (cloud.terraform)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#task2">☑️ Task 2 - Terraform Provider for Ansible <strong>(OPTIONAL)</strong></a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#task3">☑️ Task 3 - The Terraform Provider for Ansible Automation Platform</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Exercises</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Exercises</a></li>
    <li><a href="module-04.html">4. OPTIONAL - Terraform and the Certified Collection for Terraform</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<article class="doc">
<div id="preamble">
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>OPTIONAL - Terraform and the Certified Collection for Terraform teaser</p>
</div>
<div class="paragraph">
<p>Several years ago Red Hat released a certified collection for Terraform, in   this exercise you will use some of the components at the Command Line</p>
</div>
</div>
</div>
<h1 id="_optional_terraform_and_the_certified_collection_for_terraform" class="sect0"><a class="anchor" href="#_optional_terraform_and_the_certified_collection_for_terraform"></a>OPTIONAL - Terraform and the Certified Collection for Terraform</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Welcome!!!
 <strong> Grab a Coffee/Tea
 </strong> Sit back and relax
 ** You can get your hands dirty in a few minutes</p>
</div>
<div class="paragraph">
<p><strong>Please be patient as we build and connect all the components of this lab together</strong></p>
</div>
<div class="paragraph">
<p>👋 Challenge introduction.</p>
</div>
</div>
</div>
<h1 id="_optional_challenge" class="sect0"><a class="anchor" href="#_optional_challenge"></a><strong><em>OPTIONAL CHALLENGE</em></strong></h1>
<div class="sect3">
<h4 id="_estimated_time_to_complete_30_minutes"><a class="anchor" href="#_estimated_time_to_complete_30_minutes"></a>Estimated time to complete: <em>30 minutes</em></h4>

</div>
<div class="sect1">
<h2 id="_optional_terraform_and_the_red_hat_certified_collection_for_terraform_from_ansible"><a class="anchor" href="#_optional_terraform_and_the_red_hat_certified_collection_for_terraform_from_ansible"></a>OPTIONAL - Terraform and the Red Hat Certified Collection for Terraform, from Ansible</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>In this challenge you will learn</p>
<div class="ulist">
<ul>
<li>
<p>How to install the Red Hat certified collection for Terraform locally (<code>cloud.terraform</code>)</p>
</li>
<li>
<p>Use <code>ansible-playbook</code> command line tool and run an Ansible playbook that will kick off a Terraform project</p>
</li>
<li>
<p>About the Terraform Provider for Ansible, and the Terraform Provider for Ansible Automation Platform</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_certified_collections"><a class="anchor" href="#_certified_collections"></a>Certified Collections</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you have  played with Terraform, let&#8217;s have a look at the Certified Collection from Ansible.
This Red Hat certified collection for Terraform is called <code>cloud.terraform</code>.
It gives you a tried and tested method of working with Terraform from Ansible Automation Platform.</p>
</div>
<div class="paragraph">
<p>Additionally, there is also a <strong>Terraform provider for Ansible</strong> <code>ansible/ansible</code>, and a <strong>Terraform Provider for Ansible Automation Platform</strong> <code>ansible/aap</code>, for more Terraform centric work.
Both of these Terraform providers are available on the Terraform Registry site.</p>
</div>
<div class="paragraph">
<p><strong>USE CASE:</strong> You are a Terraform users and you want to start using Ansible Automation Platform to integrate your Terraform IaC into your larger automation strategy.</p>
</div>
<div class="paragraph">
<p>For this challenge you will use the Ansible command line <code>ansible-playbook</code>, and you will look at the <strong>Red Hat certfied collection for Terraform</strong> <code>cloud.terraform</code>, and you will get some exposure on how we can use the collection&#8217;s modules and components.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>[!NOTE] You can perform the following steps at the TERMINAL, or in Visual Studio Code (VSCode).
In VSCode you can open a terminal prompt.
Choose either the <code>TERMINAL</code> tab, or the <code>VSCODE</code> tab from the top of the lab screen.
We will walk through the steps using the <code>TERMINAL</code> but please feel free to do this in the <code>VSCODE</code> tab if you are more comfortable there!</p>
</div>
</blockquote>
</div>
</div>
</div>
<h1 id="task1" class="sect0"><a class="anchor" href="#task1"></a>☑️ Task 1 - Install the Red Hat certified collection for Terraform (cloud.terraform)</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>To get access to the Red Hat Certifed collection for Terraform, you will need to install it.
Open the <code>Terminal</code> tab from the top of the lab.</p>
</div>
<div class="paragraph">
<p>From the terminal prompt run the following command to install the <code>cloud.terraform</code> collection.
This will pull down the collection and install it on your local machine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ansible-galaxy collection install cloud.terraform</pre>
</div>
</div>
<div class="paragraph">
<p>Once installed, we are ready to use the collection.
Please create a playbook called <code>deploy.yml</code>.</p>
</div>
<div class="paragraph">
<p>Be sure you are in the following folder <code>/home/rhel/lab_exercises/2.Terraform_Ansible</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>cd /home/rhel/lab_exercises/2.Terraform_Ansible</pre>
</div>
</div>
<div class="paragraph">
<p>Create the <code>deploy.yml</code> file and paste in the following text.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>---
- name: Infrastructure Deployment
  hosts: localhost

  vars:
    project_dir: /home/rhel/lab_exercises/2.Terraform_Ansible

  tasks:

    - name: Basic deploy of an instance
      cloud.terraform.terraform:
        project_path: '{{ project_dir }}'
        state: present
        force_init: true

    - name: Remove Instance
      cloud.terraform.terraform:
        project_path: '{{ project_dir }}'
        state: absent
        force_init: true
      tags:
        - never
        - remove</pre>
</div>
</div>
<div class="paragraph">
<p>Once saved, run this playbook.
This will create infrastructure in AWS using the Terraform manifest file provided in the current folder <code>/home/rhel/lab_exercises/2.Terraform_Ansible</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ansible-playbook deploy.yml</pre>
</div>
</div>
<div class="paragraph">
<p>Once this has been deployed you can check it in AWS with the details provided.
Click on the <code>AWS Console</code> tab at the top of the lab.
Here you will see your temporary AWS account details needed.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/HichamMourad/terraform-aap/blob/main/images/awsconsole.png?raw=true" alt="awsconsole" width="800">
</div>
</div>
<div class="paragraph">
<p>Launch the AWS console from the <code>Account ID</code> launch link Login with the AWS credentials</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/HichamMourad/terraform-aap/blob/main/images/awslogin.png?raw=true" alt="awslogin" width="800">
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>[!NOTE] Please see that many resources have been created in AWS as a result of this Terraform project that was triggered by Ansible.</p>
</div>
<div class="paragraph">
<p><strong><em>You will see AWS infrastructure resources, like VPC, Subnets, Security groups, Route Tables, Internet Gateway, an EC2 instance and more.</em></strong></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>To remove the infrastrucre resources that were recently created by Terraform, you can simply run the Ansible playbook with the <code>remove</code> tag.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ansible-playbook deploy.yml --tags remove</pre>
</div>
</div>
<div class="paragraph">
<p>While still in the AWS console, please observe that the resources have been removed.</p>
</div>
<div class="paragraph">
<p>In summary, Ansible just performed the following while using the <code>cloud.terraform</code> collection that was installed locally</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ansible launched an Ansible playbook to trigger a Terraform project to <code>CREATE</code> the AWS infrastructure resources</p>
</li>
<li>
<p>Ansible launched an Ansible playbook to trigger a Terraform project to <code>REMOVE</code> the AWS infrastructure resources</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><em>If you recall in the first challenge we performed similar tasks from the Ansible Automation Platform user interface.</em></strong></p>
</div>
</div>
</div>
<h1 id="task2" class="sect0"><a class="anchor" href="#task2"></a>☑️ Task 2 - Terraform Provider for Ansible <strong>(OPTIONAL)</strong></h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p><strong><em>(This is an OPTIONAL task)</em></strong></p>
</div>
<div class="paragraph">
<p>There is a Terraform Provider for Ansible built by the Red Hat Ansible team.
The provider allows you to specify Ansible host information in the <code>main.tf</code>.
It allows you to define an Ansible Inventory in the <code>main.tf</code> file, and once the project is initialized and built by Terraform, you can gather Terraform resource information from the state file and push it into the Ansible Inventory.</p>
</div>
<div class="paragraph">
<p>Open the <code>Terminal</code> tab from the top of the lab.</p>
</div>
<div class="paragraph">
<p>Change to the <code>/home/rhel/lab_exercises/3.Terraform_Provider</code> folder</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cd /home/rhel/lab_exercises/3.Terraform_Provider</pre>
</div>
</div>
<div class="paragraph">
<p>If you have a look at the <code>main.tf</code>, you will see that the current <code>required_providers</code> block consists just of information about the AWS provider.
Lets add the ansible provider into this block</p>
</div>
<div class="paragraph">
<p><strong><em>BEFORE</em></strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~&gt; 6.0"
    }
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>Add the Ansible provider details into this block.
This is what that top section of the main.tf file will look like after your edits.
Feel free to use <code>vi</code> or <code>nano</code> to modify the <code>main.tf</code> file.
<strong><em>AFTER</em></strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>terraform {
  required_providers {
    ansible = {
      version = "~&gt; 1.3.0"
      source  = "ansible/ansible"
    }
    aws = {
      source  = "hashicorp/aws"
      version = "~&gt; 6.0"
    }
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>In the SSH key resource section you need to add your public key.
To retrieve the public key run this at the terminal prompt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cat  ~/.ssh/id_rsa.pub</pre>
</div>
</div>
<div class="paragraph">
<p>Now you can update the <code>aws_key_pair</code> resource with that output</p>
</div>
<div class="paragraph">
<p><strong><em>BEFORE</em></strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre># Add key for ssh connection
resource "aws_key_pair"  "my_key"  {
  key_name =  "my_key"
  public_key =  "&lt;your ssh key output&gt;"
}</pre>
</div>
</div>
<div class="paragraph">
<p><strong><em>AFTER</em></strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre># Add key for ssh connection
resource "aws_key_pair" "my_key" {
  key_name   = "my_key"
  public_key = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCSsj...but..with..your..specific..key............................"
}</pre>
</div>
</div>
<div class="paragraph">
<p>Once you have specified the Ansible provider details and added your SSH key, you need to add the Ansible host inventory details into the <code>main.tf</code>.
Add the following section to the end of the <code>main.tf</code> file</p>
</div>
<div class="listingblock">
<div class="content">
<pre>resource "ansible_host" "my_ec2" {
  name   = aws_instance.my_ec2.public_dns
  groups = ["nginx"]
  variables = {
    ansible_user                 = "ec2-user",
    ansible_ssh_private_key_file = "~/.ssh/id_rsa",
    ansible_python_interpreter   = "/usr/bin/python3",
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p><code>Save</code> the changes.</p>
</div>
<div class="paragraph">
<p>Have a look at the <code>inventory.yml</code> file and notice the plugin definition</p>
</div>
<div class="listingblock">
<div class="content">
<pre>---
plugin: cloud.terraform.terraform_provider</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s tie it all up with a simple shell script!
Create a <code>deploy.sh</code> bash script with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>#!/bin/sh

set -eux

terraform init
terraform apply -auto-approve

ansible-playbook -i inventory.yml nginx.yml

ip=$(ansible-inventory -i inventory.yml --list | jq -r '.nginx.hosts[0]')
curl "http://${ip}" --fail</pre>
</div>
</div>
<div class="paragraph">
<p>This script combines a number of steps</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>terraform init</code> and, then <code>terraform apply</code> process</p>
</li>
<li>
<p>Once the resources have been built the host details are added to the inventory file</p>
</li>
<li>
<p><strong>THEN</strong>, it starts <code>ansible-playbook</code> that runs an Ansible playbook called <code>nginx.yml</code> to configure the ec2 instance with a webserver, and add it to the Ansible Inventory</p>
</li>
<li>
<p>Ansible inventory (via the inventory plugin of the <code>cloud.terraform</code> collection) gathers the IP/hostname of the ec2 instance from the Ansible Inventory</p>
</li>
<li>
<p>Performs a quick <code>curl</code> to test that the webserver is running before exiting</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before running the script don&#8217;t forget to make it executable by running the following command at the terminal prompt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>chmod +x deploy.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Run the shell script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> ./deploy.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Upon successful completion you will see the following as a result of the <code>curl</code> test</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Once the script has finished, check the Ansible inventory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ansible-inventory -i inventory.yml --graph --vars</pre>
</div>
</div>
<div class="paragraph">
<p>You should see output similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@all:
  |--@ungrouped:
  |--@nginx:
  |  |--ec2-###-###-###-###.compute-1.amazonaws.com
  |  |  |--{ansible_python_interpreter = /usr/bin/python3}
  |  |  |--{ansible_ssh_private_key_file = ~/.ssh/id_rsa}
  |  |  |--{ansible_user = ec2-user}</pre>
</div>
</div>
<div class="paragraph">
<p>You can see that the Ansible inventory (via the inventory plugin of the <code>cloud.terraform</code> collection) has grabbed the instance details we specified in our <code>main.tf</code>.
Using the Terraform Provider for Ansible the Ansible inventory was updated with the resources created by Terraform.</p>
</div>
<div class="paragraph">
<p>Clean up by issuing a <code>terraform destroy</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>terraform destroy</pre>
</div>
</div>
<div class="paragraph">
<p>Whem prompted to <code>Enter a value:</code> please enter <code>yes</code></p>
</div>
<div class="paragraph">
<p>Once that is done let&#8217;s check the inventory again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ansible-inventory -i inventory.yml --graph --vars</pre>
</div>
</div>
<div class="paragraph">
<p>You will no longer see the host(s) details:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@all:
    |--@ungrouped:</pre>
</div>
</div>
<div class="paragraph">
<p>You can now take off the Terraform hat, and put on your Red Hat as we move to the next section and work with Ansible Automation Platform.</p>
</div>
</div>
</div>
<h1 id="task3" class="sect0"><a class="anchor" href="#task3"></a>☑️ Task 3 - The Terraform Provider for Ansible Automation Platform</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>The updated <strong>Terraform Provider for Ansible Automation Platform (AAP)</strong> allows users to send host information from Terraform into Ansible Automation Platform.</p>
</div>
<div class="paragraph">
<p>Open the <code>Terminal</code> tab from the top of the lab.</p>
</div>
<div class="paragraph">
<p>Change to the <code>/home/rhel/lab_exercises/4.Terraform_AAP_Provider</code> folder</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cd /home/rhel/lab_exercises/4.Terraform_AAP_Provider</pre>
</div>
</div>
<div class="paragraph">
<p>You have a <code>main.tf</code> file available for use</p>
</div>
<div class="paragraph">
<p>Edit the <code>main.tf</code> and create an instance that we can send to Ansible Automation Platform.</p>
</div>
<div class="paragraph">
<p>To do this you use the Terraform Provider for Ansible Automation Platform.
The provider is available globally via Hashicorp&#8217;s provider registry.</p>
</div>
<div class="paragraph">
<p>You need to modify the <code>main.tf</code> file.
Please UNCOMMENT the provider in the <code>required_provider</code> block.</p>
</div>
<div class="paragraph">
<p>Modify the <code>main.tf</code> file.
<strong><em>SIMPLY UNCOMMENT THE SECTION</em></strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "6.2.0"
    }
    aap = {
      source = "ansible/aap"
    }
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>You need to configure the <code>provider</code> block so you can send the relevant host information to the Ansible Automationm Platform.
<strong><em>SIMPLY UNCOMMENT THE SECTION</em></strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>provider "aap" {
  host     = "https://controller"
  username = "admin"
  password = "ansible123!"
  insecure_skip_verify = true
}</pre>
</div>
</div>
<div class="paragraph">
<p>Next, add the <code>resource</code> block into the manifest which is what we will push to the Ansible Automationm Platform.
<strong><em>SIMPLY UNCOMMENT THE SECTION</em></strong> at the very bottom of the file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>resource "aap_host" "tf-instance-aap-provider" {
  inventory_id = 2
  name = "aws_instance_tf"
  description = "An EC2 instance created by Terraform"
  variables = jsonencode(aws_instance.tf-instance-aap-provider)
}</pre>
</div>
</div>
<div class="paragraph">
<p>Save the <code>main.tf</code> file.</p>
</div>
<div class="paragraph">
<p>Now, please <code>init</code>ialize the Terraform project, then <code>plan</code>, and lastly <code>apply</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>terraform init</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>terraform plan -out myInstanceForAAP</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>terraform apply myInstanceForAAP</pre>
</div>
</div>
<div class="paragraph">
<p>Once successful, your instance will have been created in AWS.
However, you would also like to verify that the Terraform Provider for Ansible Automation Platform (AAP) did in fact inject the instance details into the Ansible Automation Platform Terraform Inventory.
Please remember, Terraform created the ec2 instance, and using the Terraform Provider for Ansible Automation Platform (AAP) the ec2 instance was injected into the Ansible Automation Platform Inventory.</p>
</div>
<div class="paragraph">
<p>Click on the <code>Ansible Automation Platform</code> tab at the top of lab.</p>
</div>
<div class="paragraph">
<p>Log in using the following credentials: <em>Login credentials:</em> <code>User:  admin</code>  <code>Password:  ansible123!</code></p>
</div>
<div class="paragraph">
<p>Expand the <code>Automation Execution</code> menu on the left.
<code>Automation Execution</code> -&gt; <code>Infrastructure</code> -&gt;<code> Inventories</code>.</p>
</div>
<div class="paragraph">
<p>Select the <code>Terraform Inventory</code>, and then click on the <code>Hosts</code> menu.</p>
</div>
<div class="paragraph">
<p>You will see a host called: <code>aws_instance_tf</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/HichamMourad/terraform-aap/blob/main/images/aapproviderinventory1.png?raw=true" alt="aapproviderinventory1" width="800">
</div>
</div>
<div class="paragraph">
<p>You can select the host and verify the host details which were supplied by the Terraform Provider for Ansible Automation Platform (AAP).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/HichamMourad/terraform-aap/blob/main/images/aapproviderinventory2.png?raw=true" alt="aapproviderinventory2" width="800">
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="module-03.html" class="query-params-link">3. OPTIONAL - Terraform Basics</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>  </div>
</main>
</div>
<footer class="footer">
  <a href="https://demo.redhat.com" target="_blank" class="poweredBy"><p>Powered by</p><div class="labInfo_poweredBy" style="display: block; width: 260px;"><svg class="labInfo_poweredByLogo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1508.5 178.739"><g fill="#111"><path d="M316.6 63.2v-56H342a21.279 21.279 0 0 1 7.8 1.3 18.111 18.111 0 0 1 5.9 3.5 15.577 15.577 0 0 1 5 11.8 15.051 15.051 0 0 1-3.1 9.5 16.836 16.836 0 0 1-8.4 5.8l12.5 24.1h-9.3l-11.6-23H325v23Zm24.7-48.6H325v18.7h16.3q5.25 0 8.1-2.7a8.7 8.7 0 0 0 2.8-6.6 8.7 8.7 0 0 0-2.8-6.6c-1.8-1.9-4.5-2.8-8.1-2.8ZM364.1 42.8a20.674 20.674 0 0 1 1.6-8.2 20.288 20.288 0 0 1 4.3-6.7 19.92 19.92 0 0 1 6.5-4.5 19.718 19.718 0 0 1 8-1.6 18.463 18.463 0 0 1 7.8 1.6 18.677 18.677 0 0 1 6.2 4.5 20.927 20.927 0 0 1 4.1 6.8 23.2 23.2 0 0 1 1.5 8.4v2.3H372a13.822 13.822 0 0 0 4.6 8.4 13.6 13.6 0 0 0 9.1 3.3 15.553 15.553 0 0 0 5.7-1 12.858 12.858 0 0 0 4.6-2.6l5.1 5a25.983 25.983 0 0 1-7.4 4.1 24.69 24.69 0 0 1-8.4 1.3 21.306 21.306 0 0 1-8.4-1.6 22.763 22.763 0 0 1-6.8-4.4 20.788 20.788 0 0 1-4.5-6.7 23.2 23.2 0 0 1-1.5-8.4Zm20.2-14.2a11.527 11.527 0 0 0-8 3 13.046 13.046 0 0 0-4.2 7.8h24.2a13.091 13.091 0 0 0-4.2-7.8 11.106 11.106 0 0 0-7.8-3ZM443.1 63.2v-3.8a19.448 19.448 0 0 1-5.8 3.3 18.924 18.924 0 0 1-6.7 1.2 19.824 19.824 0 0 1-14.6-6.1 22.268 22.268 0 0 1-4.4-6.7 21.812 21.812 0 0 1 0-16.4A20.534 20.534 0 0 1 416 28a19.335 19.335 0 0 1 6.6-4.5 20.334 20.334 0 0 1 8.2-1.6 20.7 20.7 0 0 1 6.6 1 19.415 19.415 0 0 1 5.7 3V7.2l8-1.8v57.8Zm-25.2-20.4a13.718 13.718 0 0 0 4 10.1 13.45 13.45 0 0 0 9.8 4.1 14.956 14.956 0 0 0 6.4-1.3 15.954 15.954 0 0 0 4.9-3.6V33.6a14.988 14.988 0 0 0-4.9-3.5 15.271 15.271 0 0 0-6.4-1.3 13.423 13.423 0 0 0-9.9 4 13.806 13.806 0 0 0-3.9 10ZM478.1 63.2v-56h8.4v24h29.8v-24h8.4v56h-8.4V38.8h-29.8v24.4ZM547.2 64a16.483 16.483 0 0 1-10.8-3.5 11.037 11.037 0 0 1-4.2-8.9 10.375 10.375 0 0 1 4.7-9.2 20.76 20.76 0 0 1 11.8-3.2 27.841 27.841 0 0 1 5.8.6 27.374 27.374 0 0 1 5.3 1.6v-4.3a8.143 8.143 0 0 0-2.6-6.5 11.452 11.452 0 0 0-7.4-2.2 20.788 20.788 0 0 0-6 .9 34.616 34.616 0 0 0-6.6 2.6l-3-6a54.169 54.169 0 0 1 8.4-3.1 33.18 33.18 0 0 1 8.3-1.1c5.2 0 9.3 1.3 12.2 3.8s4.4 6.1 4.4 10.8v27h-7.8v-3.5a19.441 19.441 0 0 1-5.8 3.2 23.54 23.54 0 0 1-6.7 1Zm-7.3-12.6a5.646 5.646 0 0 0 2.6 4.8 11.193 11.193 0 0 0 6.6 1.8 16.256 16.256 0 0 0 5.9-1 14.449 14.449 0 0 0 4.9-2.9V47a19.778 19.778 0 0 0-4.8-1.8 24.933 24.933 0 0 0-5.7-.6 11.859 11.859 0 0 0-6.8 1.8 5.728 5.728 0 0 0-2.7 5ZM580.6 53.2v-24H572v-6.7h8.6V12.1l7.9-1.9v12.3h12v6.7h-12v22.1a5.94 5.94 0 0 0 1.4 4.4c.9.9 2.5 1.3 4.6 1.3a23.637 23.637 0 0 0 3-.2 10.857 10.857 0 0 0 2.8-.8v6.7a19.28 19.28 0 0 1-3.8.9 27.484 27.484 0 0 1-3.8.3c-3.9 0-7-.9-9-2.8-2-1.7-3.1-4.4-3.1-7.9Z"></path></g><path d="M127 90.2c12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4L149.8 37c-1.7-7.1-3.2-10.3-15.7-16.6-9.7-5-30.8-13.1-37.1-13.1-5.8 0-7.5 7.5-14.4 7.5-6.7 0-11.6-5.6-17.9-5.6-6 0-9.9 4.1-12.9 12.5 0 0-8.4 23.7-9.5 27.2a4.216 4.216 0 0 0-.3 1.9c0 9.2 36.3 39.4 85 39.4Zm32.5-11.4c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3C21.8 58.8 0 61.8 0 81c0 31.5 74.6 70.3 133.7 70.3 45.3 0 56.7-20.5 56.7-36.6-.1-12.8-11-27.3-30.9-35.9Z" fill="#e00"></path><path d="M159.5 78.8c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3l3.7-9.1a4.877 4.877 0 0 0-.3 2c0 9.2 36.3 39.4 85 39.4 12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4Z"></path><path d="M253.5 158.7a2.22 2.22 0 0 1-2.2-2.2V2.2a2.2 2.2 0 0 1 4.4 0v154.2a2.242 2.242 0 0 1-2.2 2.3Z" fill="#111"></path><text data-name="Demo Platform" transform="translate(1186 149)" fill="#111" font-size="82" font-family="'RedHatDisplay', 'Overpass', overpass, helvetica, arial, sans-serif" font-weight="700"><tspan x="-877.892" y="0">Demo Platform</tspan></text></svg></div></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
